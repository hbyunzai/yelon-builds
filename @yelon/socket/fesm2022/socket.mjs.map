{"version":3,"file":"socket.mjs","sources":["../../../../packages/socket/src/socket.config.ts","../../../../packages/socket/src/notification.service.ts","../../../../packages/socket/src/stomp.service.ts","../../../../packages/socket/socket.ts"],"sourcesContent":["import { log, YunzaiConfigService, YunzaiSocketConfig } from '@yelon/util';\nimport { NzSafeAny } from 'ng-zorro-antd/core/types';\n\nexport const SOCKET_DEFAULT_CONFIG: YunzaiSocketConfig = {\n  baseUrl: '/backstage',\n  connectHeaders: {\n    login: 'guest',\n    passcode: 'guest'\n  },\n  brokerURL: '/websocket/ws/',\n  heartbeatIncoming: 1000 * 60,\n  heartbeatOutgoing: 1000 * 60,\n  reconnectDelay: 30000000,\n  debug: (msg: NzSafeAny) => {\n    log(msg);\n  }\n};\n\nexport function mergeSocketConfig(srv: YunzaiConfigService): YunzaiSocketConfig {\n  return srv.merge('socket', SOCKET_DEFAULT_CONFIG)!;\n}\n","import { Injectable } from '@angular/core';\n\nimport { NzNotificationService } from 'ng-zorro-antd/notification';\n\nimport { Message } from './interface';\n\n@Injectable({ providedIn: 'root' })\nexport class NotificationService {\n  constructor(private notifyService: NzNotificationService) {}\n\n  notify(message: Message): void {\n    this.notifyService.create(message.type!, message.title!, message.content!);\n  }\n\n  notifyWithHtml(message: Message): void {\n    this.notifyService.create(message.type!, message.title!, `<a href=${message.href}>${message.content}</a>`);\n  }\n}\n","import { DOCUMENT } from '@angular/common';\nimport { Inject, Injectable, Injector, isDevMode, OnDestroy } from '@angular/core';\nimport { Observable, Subject, takeUntil } from 'rxjs';\n\nimport { RxStomp } from '@stomp/rx-stomp';\nimport { IRxStompPublishParams } from '@stomp/rx-stomp/esm6/i-rx-stomp-publish-params';\nimport { IMessage, StompHeaders } from '@stomp/stompjs';\n\nimport { YunzaiConfigService, YunzaiSocketConfig, log, WINDOW, useLocalStorageUser, YunzaiUser } from '@yelon/util';\nimport { NzSafeAny } from 'ng-zorro-antd/core/types';\n\nimport { NotificationService } from './notification.service';\nimport { mergeSocketConfig, SOCKET_DEFAULT_CONFIG } from './socket.config';\n\n@Injectable({ providedIn: 'root' })\nexport class StompService implements OnDestroy {\n  config: YunzaiSocketConfig = SOCKET_DEFAULT_CONFIG;\n  rxStomp: RxStomp;\n  user?: YunzaiUser;\n  destroy$: Subject<unknown> = new Subject();\n\n  constructor(\n    private configService: YunzaiConfigService,\n    private injector: Injector,\n    private notifyService: NotificationService,\n    @Inject(WINDOW) private win: NzSafeAny\n  ) {\n    const [, getUser] = useLocalStorageUser();\n    if (!this.user) {\n      this.user = getUser()!;\n    }\n    this.config = mergeSocketConfig(this.configService);\n    this.rxStomp = new RxStomp();\n    if (isDevMode()) {\n      log('stomp.service: is dev mode');\n      log('stomp.service: ', `config is ${JSON.stringify(this.config)}`);\n      this.rxStomp.configure(this.config);\n      return;\n    }\n    const { location } = this.injector.get(DOCUMENT);\n    const { protocol, host } = location;\n    log('stomp.service: ', `protocol is ${protocol},host is ${host}`);\n    if (protocol.includes('http') && !protocol.includes('https')) {\n      this.config.brokerURL = `ws://${host}${this.config.brokerURL}`;\n    }\n    if (protocol.includes('https')) {\n      this.config.brokerURL = `wss://${host}${this.config.brokerURL}`;\n    }\n    log('stomp.service: ', `config is ${this.config}`);\n    this.rxStomp.configure(this.config);\n  }\n\n  ngOnDestroy(): void {\n    this.unListen();\n  }\n\n  listen(): void {\n    this.userChannel().subscribe((message: IMessage) => {\n      const body = JSON.parse(message.body);\n      this.notifyService.notifyWithHtml(body);\n    });\n\n    this.logoutChannel().subscribe((message: IMessage) => {\n      const body = JSON.parse(message.body);\n      this.notifyService.notify(body);\n      setTimeout(() => {\n        localStorage.clear();\n        this.win.location.href = `${this.config?.baseUrl}/cas-proxy/app/logout`;\n      }, 5000);\n    });\n  }\n\n  logoutChannel(): Observable<IMessage> {\n    return this.rxStomp!.watch(`/topic/layout_xx_${this.user?.username}`).pipe(takeUntil(this.destroy$));\n  }\n\n  userChannel(): Observable<IMessage> {\n    return this.rxStomp!.watch(`/topic/layout_${this.user?.username}`).pipe(takeUntil(this.destroy$));\n  }\n\n  unListen(): void {\n    this.destroy$.complete();\n    this.rxStomp!.deactivate().then();\n  }\n\n  publish(parameters: IRxStompPublishParams): void {\n    this.rxStomp!.publish(parameters);\n  }\n\n  watch(destination: string, headers?: StompHeaders): Observable<IMessage> {\n    return this.rxStomp!.watch(destination, headers);\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}