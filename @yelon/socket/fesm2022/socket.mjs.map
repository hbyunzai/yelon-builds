{"version":3,"file":"socket.mjs","sources":["../../../../packages/socket/src/socket.config.ts","../../../../packages/socket/src/notification.service.ts","../../../../packages/socket/src/stomp.service.ts","../../../../packages/socket/socket.ts"],"sourcesContent":["import { log, YunzaiConfigService, YunzaiSocketConfig } from '@yelon/util';\n\nexport const SOCKET_DEFAULT_CONFIG: YunzaiSocketConfig = {\n  baseUrl: '/backstage',\n  connectHeaders: {\n    login: 'guest',\n    passcode: 'guest'\n  },\n  brokerURL: '/websocket/ws/',\n  heartbeatIncoming: 1000 * 60,\n  heartbeatOutgoing: 1000 * 60,\n  reconnectDelay: 30000000,\n  debug: (msg: any) => {\n    log(msg);\n  }\n};\n\nexport function mergeSocketConfig(srv: YunzaiConfigService): YunzaiSocketConfig {\n  return srv.merge('socket', SOCKET_DEFAULT_CONFIG)!;\n}\n","import { inject, Injectable } from '@angular/core';\n\nimport { NzNotificationService } from 'ng-zorro-antd/notification';\n\nimport { Message } from './interface';\n\n@Injectable({ providedIn: 'root' })\nexport class NotificationService {\n  private notifyService: NzNotificationService = inject(NzNotificationService);\n\n  notify(message: Message): void {\n    this.notifyService.create(message.type!, message.title!, message.content!);\n  }\n\n  notifyWithHtml(message: Message): void {\n    this.notifyService.create(message.type!, message.title!, `<a href=${message.href}>${message.content}</a>`);\n  }\n}\n","import { DOCUMENT } from '@angular/common';\nimport { inject, Injectable, isDevMode, OnDestroy } from '@angular/core';\nimport { Observable, Subject, takeUntil } from 'rxjs';\n\nimport { RxStomp } from '@stomp/rx-stomp';\nimport { IRxStompPublishParams } from '@stomp/rx-stomp/esm6/i-rx-stomp-publish-params';\nimport { IMessage, StompHeaders } from '@stomp/stompjs';\n\nimport { YunzaiConfigService, YunzaiSocketConfig, log, WINDOW, useLocalStorageUser, YunzaiUser } from '@yelon/util';\n\nimport { NotificationService } from './notification.service';\nimport { mergeSocketConfig, SOCKET_DEFAULT_CONFIG } from './socket.config';\n\n@Injectable({ providedIn: 'root' })\nexport class StompService implements OnDestroy {\n  config: YunzaiSocketConfig = SOCKET_DEFAULT_CONFIG;\n  rxStomp: RxStomp;\n  user?: YunzaiUser;\n  destroy$ = new Subject<unknown>();\n\n  private configService: YunzaiConfigService = inject(YunzaiConfigService);\n  private notifyService: NotificationService = inject(NotificationService);\n  private win: any = inject(WINDOW);\n  private document: Document = inject(DOCUMENT);\n\n  constructor() {\n    const [, getUser] = useLocalStorageUser();\n    if (!this.user) {\n      this.user = getUser()!;\n    }\n    this.config = mergeSocketConfig(this.configService);\n    this.rxStomp = new RxStomp();\n    if (isDevMode()) {\n      log('stomp.service: is dev mode');\n      log('stomp.service: ', `config is ${JSON.stringify(this.config)}`);\n      this.rxStomp.configure(this.config);\n      return;\n    }\n    const { location } = this.document;\n    const { protocol, host } = location;\n    log('stomp.service: ', `protocol is ${protocol},host is ${host}`);\n    if (protocol.includes('http') && !protocol.includes('https')) {\n      this.config.brokerURL = `ws://${host}${this.config.brokerURL}`;\n    }\n    if (protocol.includes('https')) {\n      this.config.brokerURL = `wss://${host}${this.config.brokerURL}`;\n    }\n    log('stomp.service: ', `config is ${this.config}`);\n    this.rxStomp.configure(this.config);\n  }\n\n  ngOnDestroy(): void {\n    this.unListen();\n  }\n\n  listen(): void {\n    this.userChannel().subscribe((message: IMessage) => {\n      const body = JSON.parse(message.body);\n      this.notifyService.notifyWithHtml(body);\n    });\n\n    this.logoutChannel().subscribe((message: IMessage) => {\n      const body = JSON.parse(message.body);\n      this.notifyService.notify(body);\n      setTimeout(() => {\n        localStorage.clear();\n        this.win.location.href = `${this.config?.baseUrl}/cas-proxy/app/logout?callback=${encodeURIComponent(this.win.location.href)}`;\n      }, 5000);\n    });\n  }\n\n  logoutChannel(): Observable<IMessage> {\n    return this.rxStomp!.watch(`/topic/layout_xx_${this.user?.username}`).pipe(takeUntil(this.destroy$));\n  }\n\n  userChannel(): Observable<IMessage> {\n    return this.rxStomp!.watch(`/topic/layout_${this.user?.username}`).pipe(takeUntil(this.destroy$));\n  }\n\n  unListen(): void {\n    this.destroy$.complete();\n    this.rxStomp!.deactivate().then();\n  }\n\n  publish(parameters: IRxStompPublishParams): void {\n    this.rxStomp!.publish(parameters);\n  }\n\n  watch(destination: string, headers?: StompHeaders): Observable<IMessage> {\n    return this.rxStomp!.watch(destination, headers);\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}