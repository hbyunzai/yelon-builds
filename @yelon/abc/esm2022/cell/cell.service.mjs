import { Injectable, inject } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { map, of } from 'rxjs';
import { yn } from '@yelon/theme';
import { YunzaiConfigService } from '@yelon/util/config';
import { formatDate } from '@yelon/util/date-time';
import { CurrencyService, formatMask } from '@yelon/util/format';
import { deepMerge } from '@yelon/util/other';
import { NzI18nService } from 'ng-zorro-antd/i18n';
import * as i0 from "@angular/core";
export class CellService {
    constructor() {
        this.nzI18n = inject(NzI18nService);
        this.currency = inject(CurrencyService);
        this.dom = inject(DomSanitizer);
        this.configSrv = inject(YunzaiConfigService);
        this.globalOptions = this.configSrv.merge('cell', {
            date: { format: 'yyyy-MM-dd HH:mm:ss' },
            img: { size: 32 },
            default: { text: '-' }
        });
        this.widgets = {
            date: {
                type: 'fn',
                ref: (value, opt) => {
                    return {
                        text: formatDate(value, opt.date.format, {
                            locale: this.nzI18n.getDateLocale(),
                            customFormat: this.configSrv.get('themePipe')?.dateFormatCustom
                        })
                    };
                }
            },
            mega: {
                type: 'fn',
                ref: (value, opt) => {
                    const res = this.currency.mega(value, opt.mega);
                    return { text: res.value, unit: res.unitI18n };
                }
            },
            currency: {
                type: 'fn',
                ref: (value, opt) => {
                    return { text: this.currency.format(value, opt.currency) };
                }
            },
            cny: {
                type: 'fn',
                ref: (value, opt) => {
                    return { text: this.currency.cny(value, opt.cny) };
                }
            },
            boolean: {
                type: 'fn',
                ref: (value, opt) => {
                    return { text: this.dom.bypassSecurityTrustHtml(yn(value, opt.boolean)) };
                }
            },
            img: {
                type: 'fn',
                ref: value => {
                    return { text: Array.isArray(value) ? value : [value] };
                }
            }
        };
    }
    registerWidget(key, widget) {
        this.widgets[key] = { type: 'widget', ref: widget };
    }
    getWidget(key) {
        return this.widgets[key];
    }
    genType(value, options) {
        if (options.type != null)
            return options.type;
        const typeOf = typeof value;
        // When is timestamp
        if (typeOf === 'number' && /^[0-9]{13}$/g.test(value))
            return 'date';
        if (value instanceof Date || options.date != null)
            return 'date';
        // Auto detection
        if (options.widget != null)
            return 'widget';
        else if (options.mega != null)
            return 'mega';
        else if (options.currency != null)
            return 'currency';
        else if (options.cny != null)
            return 'cny';
        else if (options.img != null)
            return 'img';
        else if (options.link != null)
            return 'link';
        else if (options.html != null)
            return 'html';
        else if (options.badge != null)
            return 'badge';
        else if (options.tag != null)
            return 'tag';
        else if (options.checkbox != null)
            return 'checkbox';
        else if (options.radio != null)
            return 'radio';
        else if (options.enum != null)
            return 'enum';
        else if (typeOf === 'number')
            return 'number';
        else if (typeOf === 'boolean' || options.boolean != null)
            return 'boolean';
        else
            return 'string';
    }
    fixOptions(options) {
        return deepMerge({}, this.globalOptions, options);
    }
    get(value, options) {
        const type = this.genType(value, { ...options });
        const opt = this.fixOptions(options);
        opt.type = type;
        const isSafeHtml = typeof value === 'object' &&
            typeof value?.getTypeName === 'function' &&
            value?.getTypeName() != null;
        let res = {
            result: typeof value === 'object' && !isSafeHtml
                ? value
                : { text: value == null ? '' : isSafeHtml ? value : `${value}` },
            options: opt
        };
        const widget = this.widgets[type];
        if (widget?.type === 'fn') {
            res.result = widget.ref(value, opt);
        }
        return (typeof value === 'function' ? value(value, opt) : of(res.result)).pipe(map(text => {
            res.result = text;
            let dictData;
            switch (type) {
                case 'badge':
                    dictData = (opt.badge?.data ?? {})[value];
                    res.result = { color: 'default', ...dictData };
                    break;
                case 'tag':
                    dictData = (opt.tag?.data ?? {})[value];
                    res.result = dictData;
                    break;
                case 'enum':
                    res.result = { text: (opt.enum ?? {})[value] };
                    break;
                case 'html':
                    res.safeHtml = opt.html?.safe;
                    break;
                case 'string':
                    if (isSafeHtml)
                        res.safeHtml = 'safeHtml';
                    break;
            }
            if ((type === 'badge' || type === 'tag') && dictData?.tooltip != null) {
                res.options.tooltip = dictData.tooltip;
            }
            if (opt.mask != null) {
                res.result.text = formatMask(res.result.text, opt.mask);
            }
            return res;
        }));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.11", ngImport: i0, type: CellService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.11", ngImport: i0, type: CellService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.11", ngImport: i0, type: CellService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2VsbC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYWJjL2NlbGwvY2VsbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQVEsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsR0FBRyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUzQyxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsZUFBZSxFQUFFLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUU5QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7O0FBYW5ELE1BQU0sT0FBTyxXQUFXO0lBRHhCO1FBRW1CLFdBQU0sR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDL0IsYUFBUSxHQUFHLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNuQyxRQUFHLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzNCLGNBQVMsR0FBRyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNqRCxrQkFBYSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRTtZQUNuRCxJQUFJLEVBQUUsRUFBRSxNQUFNLEVBQUUscUJBQXFCLEVBQUU7WUFDdkMsR0FBRyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRTtZQUNqQixPQUFPLEVB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SyxRQUFRO29CQUNYLElBQUksVUFBVTt3QkFBRSxHQUFHLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQztvQkFDMUMsTUFBTTtZQUNWLENBQUM7WUFDRCxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sSUFBSSxJQUFJLEtBQUssS0FBSyxDQUFDLElBQUksUUFBUSxFQUFFLE9BQU8sSUFBSSxJQUFJLEVBQUUsQ0FBQztnQkFDdEUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQztZQUN6QyxDQUFDO1lBQ0QsSUFBSSxHQUFHLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRSxDQUFDO2dCQUNyQixHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFjLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BFLENBQUM7WUFDRCxPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDOytHQW5KVSxXQUFXO21IQUFYLFdBQVcsY0FERSxNQUFNOzs0RkFDbkIsV0FBVztrQkFEdkIsVUFBVTttQkFBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBUeXBlLCBpbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERvbVNhbml0aXplciB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xuaW1wb3J0IHsgbWFwLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyB5biB9IGZyb20gJ0B5ZWxvbi90aGVtZSc7XG5pbXBvcnQgeyBZdW56YWlDb25maWdTZXJ2aWNlIH0gZnJvbSAnQHllbG9uL3V0aWwvY29uZmlnJztcbmltcG9ydCB7IGZvcm1hdERhdGUgfSBmcm9tICdAeWVsb24vdXRpbC9kYXRlLXRpbWUnO1xuaW1wb3J0IHsgQ3VycmVuY3lTZXJ2aWNlLCBmb3JtYXRNYXNrIH0gZnJvbSAnQHllbG9uL3V0aWwvZm9ybWF0JztcbmltcG9ydCB7IGRlZXBNZXJnZSB9IGZyb20gJ0B5ZWxvbi91dGlsL290aGVyJztcbmltcG9ydCB0eXBlIHsgTnpTYWZlQW55IH0gZnJvbSAnbmctem9ycm8tYW50ZC9jb3JlL3R5cGVzJztcbmltcG9ydCB7IE56STE4blNlcnZpY2UgfSBmcm9tICduZy16b3Jyby1hbnRkL2kxOG4nO1xuXG5pbXBvcnQgdHlwZSB7XG4gIENlbGxGdVZhbHVlLFxuICBDZWxsT3B0aW9ucyxcbiAgQ2VsbFRleHRSZXN1bHQsXG4gIENlbGxUZXh0VW5pdCxcbiAgQ2VsbFR5cGUsXG4gIENlbGxXaWRnZXQsXG4gIENlbGxXaWRnZXRGblxufSBmcm9tICcuL2NlbGwudHlwZXMnO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIENlbGxTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBuekkxOG4gPSBpbmplY3QoTnpJMThuU2VydmljZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgY3VycmVuY3kgPSBpbmplY3QoQ3VycmVuY3lTZXJ2aWNlKTtcbiAgcHJpdmF0ZSByZWFkb25seSBkb20gPSBpbmplY3QoRG9tU2FuaXRpemVyKTtcbiAgcHJpdmF0ZSByZWFkb25seSBjb25maWdTcnYgPSBpbmplY3QoWXVuemFpQ29uZmlnU2VydmljZSk7XG4gIHByaXZhdGUgZ2xvYmFsT3B0aW9ucyA9IHRoaXMuY29uZmlnU3J2Lm1lcmdlKCdjZWxsJywge1xuICAgIGRhdGU6IHsgZm9ybWF0OiAneXl5eS1NTS1kZCBISDptbTpzcycgfSxcbiAgICBpbWc6IHsgc2l6ZTogMzIgfSxcbiAgICBkZWZhdWx0OiB7IHRleHQ6ICctJyB9XG4gIH0pITtcbiAgcHJpdmF0ZSB3aWRnZXRzOiB7IFtrZXk6IHN0cmluZ106IENlbGxXaWRnZXQgfSA9IHtcbiAgICBkYXRlOiB7XG4gICAgICB0eXBlOiAnZm4nLFxuICAgICAgcmVmOiAodmFsdWUsIG9wdCkgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHRleHQ6IGZvcm1hdERhdGUodmFsdWUgYXMgc3RyaW5nLCBvcHQuZGF0ZSEuZm9ybWF0ISwge1xuICAgICAgICAgICAgbG9jYWxlOiB0aGlzLm56STE4bi5nZXREYXRlTG9jYWxlKCksXG4gICAgICAgICAgICBjdXN0b21Gb3JtYXQ6IHRoaXMuY29uZmlnU3J2LmdldCgndGhlbWVQaXBlJyk/LmRhdGVGb3JtYXRDdXN0b21cbiAgICAgICAgICB9KVxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH0sXG4gICAgbWVnYToge1xuICAgICAgdHlwZTogJ2ZuJyxcbiAgICAgIHJlZjogKHZhbHVlLCBvcHQpID0+IHtcbiAgICAgICAgY29uc3QgcmVzID0gdGhpcy5jdXJyZW5jeS5tZWdhKHZhbHVlIGFzIG51bWJlciwgb3B0Lm1lZ2EpO1xuICAgICAgICByZXR1cm4geyB0ZXh0OiByZXMudmFsdWUsIHVuaXQ6IHJlcy51bml0STE4biB9O1xuICAgICAgfVxuICAgIH0sXG4gICAgY3VycmVuY3k6IHtcbiAgICAgIHR5cGU6ICdmbicsXG4gICAgICByZWY6ICh2YWx1ZSwgb3B0KSA9PiB7XG4gICAgICAgIHJldHVybiB7IHRleHQ6IHRoaXMuY3VycmVuY3kuZm9ybWF0KHZhbHVlIGFzIG51bWJlciwgb3B0LmN1cnJlbmN5KSB9O1xuICAgICAgfVxuICAgIH0sXG4gICAgY255OiB7XG4gICAgICB0eXBlOiAnZm4nLFxuICAgICAgcmVmOiAodmFsdWUsIG9wdCkgPT4ge1xuICAgICAgICByZXR1cm4geyB0ZXh0OiB0aGlzLmN1cnJlbmN5LmNueSh2YWx1ZSBhcyBudW1iZXIsIG9wdC5jbnkpIH07XG4gICAgICB9XG4gICAgfSxcbiAgICBib29sZWFuOiB7XG4gICAgICB0eXBlOiAnZm4nLFxuICAgICAgcmVmOiAodmFsdWUsIG9wdCkgPT4ge1xuICAgICAgICByZXR1cm4geyB0ZXh0OiB0aGlzLmRvbS5ieXBhc3NTZWN1cml0eVRydXN0SHRtbCh5bih2YWx1ZSBhcyBib29sZWFuLCBvcHQuYm9vbGVhbikpIH07XG4gICAgICB9XG4gICAgfSxcbiAgICBpbWc6IHtcbiAgICAgIHR5cGU6ICdmbicsXG4gICAgICByZWY6IHZhbHVlID0+IHtcbiAgICAgICAgcmV0dXJuIHsgdGV4dDogQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZSA6IFt2YWx1ZV0gfTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgcmVnaXN0ZXJXaWRnZXQoa2V5OiBzdHJpbmcsIHdpZGdldDogVHlwZTx1bmtub3duPik6IHZvaWQge1xuICAgIHRoaXMud2lkZ2V0c1trZXldID0geyB0eXBlOiAnd2lkZ2V0JywgcmVmOiB3aWRnZXQgfTtcbiAgfVxuXG4gIGdldFdpZGdldChrZXk6IHN0cmluZyk6IENlbGxXaWRnZXQgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLndpZGdldHNba2V5XTtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuVHlwZSh2YWx1ZTogdW5rbm93biwgb3B0aW9uczogQ2VsbE9wdGlvbnMpOiBDZWxsVHlwZSB7XG4gICAgaWYgKG9wdGlvbnMudHlwZSAhPSBudWxsKSByZXR1cm4gb3B0aW9ucy50eXBlO1xuXG4gICAgY29uc3QgdHlwZU9mID0gdHlwZW9mIHZhbHVlO1xuICAgIC8vIFdoZW4gaXMgdGltZXN0YW1wXG4gICAgaWYgKHR5cGVPZiA9PT0gJ251bWJlcicgJiYgL15bMC05XXsxM30kL2cudGVzdCh2YWx1ZSBhcyBzdHJpbmcpKSByZXR1cm4gJ2RhdGUnO1xuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUgfHwgb3B0aW9ucy5kYXRlICE9IG51bGwpIHJldHVybiAnZGF0ZSc7XG5cbiAgICAvLyBBdXRvIGRldGVjdGlvblxuICAgIGlmIChvcHRpb25zLndpZGdldCAhPSBudWxsKSByZXR1cm4gJ3dpZGdldCc7XG4gICAgZWxzZSBpZiAob3B0aW9ucy5tZWdhICE9IG51bGwpIHJldHVybiAnbWVnYSc7XG4gICAgZWxzZSBpZiAob3B0aW9ucy5jdXJyZW5jeSAhPSBudWxsKSByZXR1cm4gJ2N1cnJlbmN5JztcbiAgICBlbHNlIGlmIChvcHRpb25zLmNueSAhPSBudWxsKSByZXR1cm4gJ2NueSc7XG4gICAgZWxzZSBpZiAob3B0aW9ucy5pbWcgIT0gbnVsbCkgcmV0dXJuICdpbWcnO1xuICAgIGVsc2UgaWYgKG9wdGlvbnMubGluayAhPSBudWxsKSByZXR1cm4gJ2xpbmsnO1xuICAgIGVsc2UgaWYgKG9wdGlvbnMuaHRtbCAhPSBudWxsKSByZXR1cm4gJ2h0bWwnO1xuICAgIGVsc2UgaWYgKG9wdGlvbnMuYmFkZ2UgIT0gbnVsbCkgcmV0dXJuICdiYWRnZSc7XG4gICAgZWxzZSBpZiAob3B0aW9ucy50YWcgIT0gbnVsbCkgcmV0dXJuICd0YWcnO1xuICAgIGVsc2UgaWYgKG9wdGlvbnMuY2hlY2tib3ggIT0gbnVsbCkgcmV0dXJuICdjaGVja2JveCc7XG4gICAgZWxzZSBpZiAob3B0aW9ucy5yYWRpbyAhPSBudWxsKSByZXR1cm4gJ3JhZGlvJztcbiAgICBlbHNlIGlmIChvcHRpb25zLmVudW0gIT0gbnVsbCkgcmV0dXJuICdlbnVtJztcbiAgICBlbHNlIGlmICh0eXBlT2YgPT09ICdudW1iZXInKSByZXR1cm4gJ251bWJlcic7XG4gICAgZWxzZSBpZiAodHlwZU9mID09PSAnYm9vbGVhbicgfHwgb3B0aW9ucy5ib29sZWFuICE9IG51bGwpIHJldHVybiAnYm9vbGVhbic7XG4gICAgZWxzZSByZXR1cm4gJ3N0cmluZyc7XG4gIH1cblxuICBmaXhPcHRpb25zKG9wdGlvbnM/OiBDZWxsT3B0aW9ucyk6IENlbGxPcHRpb25zIHtcbiAgICByZXR1cm4gZGVlcE1lcmdlKHt9LCB0aGlzLmdsb2JhbE9wdGlvbnMsIG9wdGlvbnMpO1xuICB9XG5cbiAgZ2V0KHZhbHVlOiB1bmtub3duLCBvcHRpb25zPzogQ2VsbE9wdGlvbnMpOiBPYnNlcnZhYmxlPENlbGxUZXh0UmVzdWx0PiB7XG4gICAgY29uc3QgdHlwZSA9IHRoaXMuZ2VuVHlwZSh2YWx1ZSwgeyAuLi5vcHRpb25zIH0pO1xuICAgIGNvbnN0IG9wdCA9IHRoaXMuZml4T3B0aW9ucyhvcHRpb25zKTtcbiAgICBvcHQudHlwZSA9IHR5cGU7XG4gICAgY29uc3QgaXNTYWZlSHRtbCA9XG4gICAgICB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmXG4gICAgICB0eXBlb2YgKHZhbHVlIGFzIE56U2FmZUFueSk/LmdldFR5cGVOYW1lID09PSAnZnVuY3Rpb24nICYmXG4gICAgICAodmFsdWUgYXMgTnpTYWZlQW55KT8uZ2V0VHlwZU5hbWUoKSAhPSBudWxsO1xuXG4gICAgbGV0IHJlczogQ2VsbFRleHRSZXN1bHQgPSB7XG4gICAgICByZXN1bHQ6XG4gICAgICAgIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgIWlzU2FmZUh0bWxcbiAgICAgICAgICA/ICh2YWx1ZSBhcyBDZWxsVGV4dFVuaXQpXG4gICAgICAgICAgOiB7IHRleHQ6IHZhbHVlID09IG51bGwgPyAnJyA6IGlzU2FmZUh0bWwgPyB2YWx1ZSA6IGAke3ZhbHVlfWAgfSxcbiAgICAgIG9wdGlvbnM6IG9wdFxuICAgIH07XG5cbiAgICBjb25zdCB3aWRnZXQgPSB0aGlzLndpZGdldHNbdHlwZV07XG4gICAgaWYgKHdpZGdldD8udHlwZSA9PT0gJ2ZuJykge1xuICAgICAgcmVzLnJlc3VsdCA9ICh3aWRnZXQucmVmIGFzIENlbGxXaWRnZXRGbikodmFsdWUsIG9wdCk7XG4gICAgfVxuXG4gICAgcmV0dXJuICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgPyAodmFsdWUgYXMgQ2VsbEZ1VmFsdWUpKHZhbHVlLCBvcHQpIDogb2YocmVzLnJlc3VsdCkpLnBpcGUoXG4gICAgICBtYXAodGV4dCA9PiB7XG4gICAgICAgIHJlcy5yZXN1bHQgPSB0ZXh0O1xuICAgICAgICBsZXQgZGljdERhdGE6IHsgdG9vbHRpcD86IHN0cmluZyB9IHwgdW5kZWZpbmVkO1xuICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgICAgICBjYXNlICdiYWRnZSc6XG4gICAgICAgICAgICBkaWN0RGF0YSA9IChvcHQuYmFkZ2U/LmRhdGEgPz8ge30pW3ZhbHVlIGFzIHN0cmluZ107XG4gICAgICAgICAgICByZXMucmVzdWx0ID0geyBjb2xvcjogJ2RlZmF1bHQnLCAuLi5kaWN0RGF0YSB9O1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAndGFnJzpcbiAgICAgICAgICAgIGRpY3REYXRhID0gKG9wdC50YWc/LmRhdGEgPz8ge30pW3ZhbHVlIGFzIHN0cmluZ107XG4gICAgICAgICAgICByZXMucmVzdWx0ID0gZGljdERhdGEgYXMgQ2VsbFRleHRVbml0O1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnZW51bSc6XG4gICAgICAgICAgICByZXMucmVzdWx0ID0geyB0ZXh0OiAob3B0LmVudW0gPz8ge30pW3ZhbHVlIGFzIHN0cmluZ10gfTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ2h0bWwnOlxuICAgICAgICAgICAgcmVzLnNhZmVIdG1sID0gb3B0Lmh0bWw/LnNhZmU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICAgICAgaWYgKGlzU2FmZUh0bWwpIHJlcy5zYWZlSHRtbCA9ICdzYWZlSHRtbCc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBpZiAoKHR5cGUgPT09ICdiYWRnZScgfHwgdHlwZSA9PT0gJ3RhZycpICYmIGRpY3REYXRhPy50b29sdGlwICE9IG51bGwpIHtcbiAgICAgICAgICByZXMub3B0aW9ucy50b29sdGlwID0gZGljdERhdGEudG9vbHRpcDtcbiAgICAgICAgfVxuICAgICAgICBpZiAob3B0Lm1hc2sgIT0gbnVsbCkge1xuICAgICAgICAgIHJlcy5yZXN1bHQudGV4dCA9IGZvcm1hdE1hc2socmVzLnJlc3VsdC50ZXh0IGFzIHN0cmluZywgb3B0Lm1hc2spO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXM7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbn1cbiJdfQ==